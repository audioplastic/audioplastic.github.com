---
layout: post
title: "Audiophile AirPlay with Raspberry Pi: Part 1"
date: 2013-01-08 14:44
comments: true
categories: 
---

Perhaps begin with end results:
Was looking to get Apple TV just for audio straming - wanted to look at high end airplay audio quality

Had a Pi gathering dust


How to:



FIRST STEPS - UPGRADE PACKAGES!

root@raspberrypi:~# aptitude update
root@raspberrypi:~# aptitude upgrade


On my system 

```
pi@raspberrypi ~ $ uname -a
Linux raspberrypi 3.6.11+ #348 PREEMPT Tue Jan 1 16:33:22 GMT 2013 armv6l GNU/Linux
```



THEN UPGRADE FIRMWARE

root@raspberrypi:~# rpi-update

For me, this fialed on the first run, but worked OK on the second attempt.

for details:
https://github.com/Hexxeh/rpi-update

NOW TO TEST AIRPLAY WITH CRAPPY INTERNAL SOUND

Follow this
http://trouch.com/2012/08/03/airpi-airplay-audio-with-raspberry/

Change audio output
To force audio output to stereo jack, a single line is required :

root@raspberrypi:~# amixer cset numid=3 1
Install shairport
Before download and compile shairport, we need to install prerequisites :

root@raspberrypi:~# aptitude install git libao-dev libssl-dev libcrypt-openssl-rsa-perl libio-socket-inet6-perl libwww-perl avahi-utils

Additional step not in original instructions ...
Needed to get the Net::sdp perl lib - was easy as ..
sudo cpan install Net::SDP


Then download shairport sources and compile it :
root@raspberrypi:~# git clone https://github.com/albertz/shairport.git shairport
root@raspberrypi:~# cd shairport
root@raspberrypi:~/shairport# make
Finally, launch shairport foreground :

root@raspberrypi:~/shairport# ./shairport.pl -a AirPi
You can now use your iDevice to try AirPlay audio, donâ€™t forget to plug an headphone or speakers into the 3.5mm stereo jack.


NOW TO GET AN EXTERNAL USB DAC WORKING WITHOUT POPS AND CLICKS

sudo apt-get install libasound2-plugins
sudo apt-get install libesd0
sudo apt-get install nas

added 'dwc_otg.speed=1' and dwc_otg.fiq_fix_enable=1 to /boot/cmdline.txt AT THE BEGINNING OF THE LINE

modified /etc/libao.conf as such:
default_driver=alsa
dev=default
use_mmap=no


```
sudo nano /etc/modprobe.d/alsa-base.conf 
```

Making the modifications ...

```
#options snd-usb-audio index=-2
options snd_bcm2835 index=-2
```

Then in .asoundrc

```
pcm.!default {
    type plug
    slave.pcm "softvol"
}
pcm.dmixer {
       type dmix
       ipc_key 1024
       slave {
           pcm "hw:0"
           period_time 0
           period_size 4096
           buffer_size 131072
           rate 44100
       }
       bindings {
           0 0
           1 1
       }
}
pcm.dsnooper {
       type dsnoop
       ipc_key 1024
       slave {
           pcm "hw:0"
           channels 2
           period_time 0
           period_size 4096
           buffer_size 131072
           rate 1
       }
       bindings {
           0 0
           1 1
       }
}
pcm.softvol {
       type softvol
       slave { pcm "dmixer" }
       control {
           name "Master"
           card 0
       }
}
ctl.!default {
    type hw
    card 0
}
ctl.softvol {
    type hw
    card 0
}
ctl.dmixer {
    type hw
    card 0
}

```

RESTART PI
Test with..
root@raspberrypi:~/shairport# ./shairport.pl -a AirPi

If this all works you're golden to make a Demon process

TO MAKE A DEMON PROCESS

Need to copy local .asoundrc to /etc/asound.conf
This tripped me up for a bit!

root@raspberrypi:~/shairport# make install
root@raspberrypi:~/shairport# cp shairport.init.sample /etc/init.d/shairport
root@raspberrypi:~/shairport# cd /etc/init.d
root@raspberrypi:/etc/init.d# chmod a+x shairport
root@raspberrypi:/etc/init.d# update-rc.d shairport defaults
Before starting the daemon, we have to add the AP Name in the launch parameters. Edit the file using nano shairport then change the DAEMON_ARGS variable line so it looks like to :

DAEMON_ARGS="-w $PIDFILE -a AirPi"
Replace AirPi by whatever you want, save, quit and start the service to enjoy shairport in background and your AirPi :

root@raspberrypi:/etc/init.d# ./shairport start




